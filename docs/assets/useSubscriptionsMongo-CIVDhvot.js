import{r as u,p}from"./index-Da3oJxeQ.js";const c="http://localhost:3001/api";function A(){const s=u([]),o=u(!1),n=u(null),l=u([]),f=t=>({id:t.id??(t._id?String(t._id):void 0),userId:String(t.userId),name:String(t.name),price:Number(t.price),currency:t.currency,cycle:t.cycle,billingDate:new Date(t.billingDate),reminderDays:t.reminderDays??3,category:t.category,createdAt:t.createdAt?new Date(t.createdAt):void 0,updatedAt:t.updatedAt?new Date(t.updatedAt):void 0}),y=p(()=>s.value.filter(t=>t.cycle==="monthly").reduce((t,e)=>t+e.price,0)),g=p(()=>s.value.filter(t=>t.cycle==="yearly").reduce((t,e)=>t+e.price,0)),d=p(()=>{const t=new Date,e=new Date(t.getTime()+10080*60*1e3);return s.value.filter(r=>{if(!r.billingDate)return!1;const a=new Date(r.billingDate);return a>=t&&a<=e}).sort((r,a)=>!r.billingDate||!a.billingDate?0:new Date(r.billingDate).getTime()-new Date(a.billingDate).getTime())});return{subscriptions:s,loading:o,error:n,monthlyTotal:y,yearlyTotal:g,upcomingPayments:d,fetchSubscriptions:async t=>{if(!t)return;o.value=!0,n.value=null;const e=new AbortController,r=setTimeout(()=>e.abort(),7e3);try{const a=await fetch(`${c}/subscriptions/${t}`,{signal:e.signal});if(!a.ok)throw new Error("Failed to fetch subscriptions");const i=await a.json();s.value=Array.isArray(i)?i.map(f):[]}catch(a){const i=a instanceof Error?a.message:"Failed to fetch subscriptions";n.value=i.includes("AbortError")?"Превышено время ожидания загрузки":i,console.error("Error fetching subscriptions:",a)}finally{clearTimeout(r),o.value=!1}},createSubscription:async t=>{o.value=!0,n.value=null;try{const e=await fetch(`${c}/subscriptions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error("Failed to create subscription");const r=f(await e.json());return s.value.push(r),r}catch(e){throw n.value=e instanceof Error?e.message:"Failed to create subscription",console.error("Error creating subscription:",e),e}finally{o.value=!1}},updateSubscription:async(t,e)=>{o.value=!0,n.value=null;try{if(!(await fetch(`${c}/subscriptions/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw new Error("Failed to update subscription");const a=s.value.findIndex(i=>i.id===t);if(a!==-1){const{userId:i,...h}=e;s.value[a]={...s.value[a],...h}}}catch(r){throw n.value=r instanceof Error?r.message:"Failed to update subscription",console.error("Error updating subscription:",r),r}finally{o.value=!1}},deleteSubscription:async t=>{o.value=!0,n.value=null;try{if(!(await fetch(`${c}/subscriptions/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete subscription");s.value=s.value.filter(r=>r.id!==t)}catch(e){throw n.value=e instanceof Error?e.message:"Failed to delete subscription",console.error("Error deleting subscription:",e),e}finally{o.value=!1}},getStats:async t=>{try{const e=await fetch(`${c}/subscriptions/${t}/stats`);if(!e.ok)throw new Error("Failed to fetch stats");return await e.json()}catch(e){return console.error("Error fetching stats:",e),{totalMonthly:0,totalYearly:0,count:0}}},categories:l,fetchCategories:async t=>{if(t){o.value=!0,n.value=null;try{const e=await fetch(`${c}/categories/${t}`);if(!e.ok)throw new Error("Failed to fetch categories");const r=await e.json();l.value=Array.isArray(r)?r:[]}catch(e){const r=e instanceof Error?e.message:"Failed to fetch categories";n.value=r,console.error("Error fetching categories:",e)}finally{o.value=!1}}},createCategory:async t=>{o.value=!0,n.value=null;try{const e=await fetch(`${c}/categories`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error("Failed to create category");const r=await e.json();return l.value.push(r),r}catch(e){throw n.value=e instanceof Error?e.message:"Failed to create category",console.error("Error creating category:",e),e}finally{o.value=!1}},deleteCategory:async t=>{o.value=!0,n.value=null;try{if(!(await fetch(`${c}/categories/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete category");l.value=l.value.filter(r=>r.id!==t)}catch(e){throw n.value=e instanceof Error?e.message:"Failed to delete category",console.error("Error deleting category:",e),e}finally{o.value=!1}}}}export{A as u};
